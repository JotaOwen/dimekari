fs = require('fs')
class Kn3
  constructor: (Taringa) ->
    @taringa = Taringa

  upload: (file, callback) ->
    self = @
    req = @taringa.request.post 'http://kn3.net/upload.php', (error, response, body) ->
        if !error and response.statusCode is 200
          data = JSON.parse(body)
          fs.unlink file
          callback.call this, false, data['direct']
        else
          fs.unlink file
          callback.call this, 'Kn3::upload Request was not succesful'
    form = req.form()
    form.append 'files[]', fs.createReadStream(file)

  import: (url,callback) ->
    self = @
    @taringa.request.head url, (err, res, body) ->
      if !err
        console.log 'content-length:', res.headers['content-length']
        if 0 < res.headers['content-length'] and res.headers['content-length'] <= 2499334
          self.taringa.request(url).pipe(fs.createWriteStream("temporal.png")).on 'close', () ->
            self.upload("temporal.png",callback)
        else
          callback.call this, 'Kn3::import Archivo muy grande'
      else
        callback.call this, 'Kn3::import Request was not succesful'

module.exports = Kn3